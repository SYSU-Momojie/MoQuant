<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.momojie.moquant.api.dao.MqQuarterIndicatorDao">

    <resultMap id="QuarterMap" type="com.cn.momojie.moquant.api.dto.MqQuarterIndicator">
        <result column="ts_code" jdbcType="VARCHAR" property="tsCode"/>
        <result column="period" jdbcType="VARCHAR" property="period"/>
        <result column="report_type" jdbcType="INTEGER" property="reportType"/>
        <result column="update_date" jdbcType="VARCHAR" property="updateDate"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="value" jdbcType="DECIMAL" property="value"/>
        <result column="yoy" jdbcType="DECIMAL" property="yoy"/>
        <result column="mom" jdbcType="DECIMAL" property="mom"/>
    </resultMap>

    <select id="getQuarterLatest" resultMap="QuarterMap">
        SELECT o. * FROM mq_quarter_indicator o
        RIGHT JOIN (
        SELECT t.ts_code, t.period,
        MAX(t.update_date) AS update_date
        FROM mq_quarter_indicator t
        RIGHT JOIN
        (
        SELECT ts_code,
        max(period) AS period
        FROM mq_quarter_indicator
        WHERE update_date <![CDATA[ <= ]]> #{underDate} AND update_date <![CDATA[ >= ]]> #{lastYear}
        AND ts_code IN <foreach collection="codeList" item="codeI" open="(" separator="," close=")">#{codeI}</foreach>
        GROUP BY ts_code
        ) gp
        ON t.ts_code = gp.ts_code AND t.period = gp.period
        WHERE t.ts_code IS NOT NULL
        GROUP BY t.ts_code, t.period
        ) gp2
        ON o.ts_code = gp2.ts_code AND o.period = gp2.period AND o.update_date = gp2.update_date
        WHERE o.ts_code IS NOT NULL
        <if test="nameList != null and nameList.size > 0">
            AND o.name IN <foreach collection="nameList" item="nameI" open="(" separator="," close=")">#{nameI}</foreach>
        </if>
    </select>

</mapper>